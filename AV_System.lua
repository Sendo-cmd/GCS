repeat task.wait() until game:IsLoaded()
repeat task.wait() until game:GetService("Players").LocalPlayer
repeat task.wait() until game:GetService("Players").LocalPlayer.PlayerGui

game:GetService("Players").LocalPlayer:WaitForChild("PlayerGui")
local function Next_(var)
    local duration = tick() + var
    repeat task.wait() until tick() >= duration
end
--[[
Portal 
Sand Village
Double Dungeon
Planet Namak
Shibuya Station
Underground Church
Spirit Society
]]

--[[
Story Stage Map
Planet Namak
Spirit Society
Underground Church
Sand Village
Shibuya Station
Double Dungeon
]]

--[[
Legend Stage Map
Sand Village
Kuinshi Palace
Golden Castle
Shibuya Aftermath
Double Dungeon
]]

--[[
Dungeon Map
Mountain Shrine (Natural)
Ant Island
]]

--[[
Raid Map
Spider Forest
Tracks at the Edge of the World
]]



__G.User = {
    ["KOW7Po"] = {
        ["Select Mode"] = "Portal", -- Portal
        ["Party Mode"] = true,
        ["Party Member"] = {
            "Rynar50144",
            "HolyBus",
            "mafsui7234"
        },
        ["Portal Settings"] = {
            ["ID"] = 113, -- 113 Love , 87 Winter
            ["Tier Cap"] = 10,
            ["Method"] = "Highest", -- Highest , Lowest
            ["Ignore Stage"] = {"Shibuya Station"},
            ["Ignore Modify"] = {},
        },
    },
    ["Rynar50144"] = {
        ["Party Mode"] = true,
    },
    ["avremin27"] = {
        ["Party Mode"] = true,
    },
    ["HolyBus"] = {
        ["Party Mode"] = true,
    },
    ["Gu_Peem"] = {
        ["Party Mode"] = true,
    },
    ["mafsui7234"] = {
        ["Party Mode"] = true,
    },
    ["nongmai813"] = {
        ["Party Mode"] = true,
    },
    ["Blastch8892"] = {
        ["Party Mode"] = true,
    },
    ["Dwekyphwzxpsg"] = {
        ["Party Mode"] = true,
    },
    ["scp1774"] = {
        ["Party Mode"] = true,
    },
    ["svieex10"] = {
        ["Party Mode"] = true,
    },
    ["YoScoreDummy"] = {
        ["Party Mode"] = true,
    },
    ["keam093321"] = {
        ["Party Mode"] = true,
    },
    ["lnwyorn_0823"] = {
        ["Party Mode"] = true,
    },
    ["344t0sHCdw6oDK"] = {
        ["Party Mode"] = true,
    },
    ["x8s0r1y5knI3Ls"] = {
        ["Party Mode"] = true,
    },
    ["Lucinda2471"] = {
        ["Select Mode"] = "Portal", -- Portal
        ["Party Mode"] = true,
        ["Party Member"] = {
            "YoScoreDummy",
            "344t0sHCdw6oDK",
            "x8s0r1y5knI3Ls"
        },
        ["Portal Settings"] = {
            ["ID"] = 87, -- 113 Love , 87 Winter
            ["Tier Cap"] = 10,
            ["Method"] = "Highest", -- Highest , Lowest
            ["Ignore Stage"] = {"Spider Forest"},
            ["Ignore Modify"] = {},
        },
    },
    ["RyuzaaaV2"] = {
        ["Select Mode"] = "Portal", -- Portal
        ["Party Mode"] = true,
        ["Party Member"] = {
            "Gus001934",
            "tangdda",
            "shadoTsunami"
        },
        ["Portal Settings"] = {
            ["ID"] = 87, -- 113 Love , 87 Winter
            ["Tier Cap"] = 10,
            ["Method"] = "Highest", -- Highest , Lowest
            ["Ignore Stage"] = {"Spider Forest"},
            ["Ignore Modify"] = {},
        },
    },
    ["Gus001934"] = {
        ["Party Mode"] = true,
    },
    ["tangdda"] = {
        ["Party Mode"] = true,
    },
    ["ball77071"] = {
        ["Party Mode"] = true,
    },
    ["saveew"] = {
        ["Party Mode"] = true,
    },
    ["robid1450"] = {
        ["Party Mode"] = true,
    },
    ["enonef2"] = {
        ["Party Mode"] = true,
    },
    ["scarygirl362"] = {
        ["Party Mode"] = true,
    },
    ["bigyoshi909"] = {
        ["Party Mode"] = true,
    },
    ["GCshop2"] = {
        ["Party Mode"] = false,
    },
    ["shadoTsunami"] = {
        ["Party Mode"] = true,
    },
    ["Bregas1170"] = {
        ["Select Mode"] = "Portal", -- Portal
        ["Party Mode"] = true,
        ["Party Member"] = {
            "GZ10966"
        },
        ["Portal Settings"] = {
            ["ID"] = 87, -- 113 Love , 87 Winter
            ["Tier Cap"] = 10,
            ["Method"] = "Highest", -- Highest , Lowest
            ["Ignore Stage"] = {"Spider Forest"},
            ["Ignore Modify"] = {},
        },
    },
    ["lpkiohuyvguyh"] = {
        ["Party Mode"] = true,
    },
    ["GZ10966"] = {
        ["Party Mode"] = true,
    },
    ["Pokampud"] = {
        ["Party Mode"] = true,
    },
    ["unf0rg1ven_249"] = {
        ["Party Mode"] = true,
    },
    ["entanwit2817"] = {
        ["Party Mode"] = true,
    },
    ["Captainlnwza005"] = {
        ["Select Mode"] = "Dungeon", -- Portal
        ["Party Mode"] = true,
        ["Party Member"] = {
            "saveew",
            "Skate9517",
            "MonarchJINWO21"
        },
        ["Dungeon Settings"] = {
            ["Difficulty"] = "Nightmare",
            ["Act"] = "AntIsland",
            ["StageType"] = "Dungeon",
            ["Stage"] = "Ant Island",
            ["FriendsOnly"] = false
        },    
    },
    ["MonarchJINWO21"] = {
        ["Party Mode"] = true,
    },
    ["Skate9517"] = {
        ["Party Mode"] = true,
    },
    ["Primo_Dzek"] = {
        ["Party Mode"] = true,
    },
    ["Embeflu8651"] = {
        ["Party Mode"] = true,
    },
    ["zywimq"] = {
        ["Party Mode"] = true,
    },
    ["Zboy1XD"] = {
        ["Party Mode"] = true,
    },
    ["MEEMDAY2530"] = {
        ["Party Mode"] = true,
    },
    ["AceLilFellow"] = {
        ["Party Mode"] = true,
    },
    ["OVERDOG_KUNG"] = {
        ["Party Mode"] = true,
    },
    ["zxzxc666"] = {
        ["Party Mode"] = true,
    },
    ["traijo"] = {
        ["Party Mode"] = true,
    },
    ["anakin_av139"] = {
        ["Party Mode"] = true,
    },
    ["ASD_King70"] = {
        ["Party Mode"] = true,
    },
    ["rain4834"] = {
        ["Party Mode"] = true,
    },
    ["HaineToram2"] = {
        ["Party Mode"] = true,
    },
    ["Gameeeq52"] = {
        ["Party Mode"] = true,
    },
    ["Sobiebugge84811"] = {
        ["Party Mode"] = true,
    },
}

-- Service
local HttpService = game:GetService("HttpService")
local TextChatService = game:GetService("TextChatService")

-- Unity
local function LoadModule(path)
    local Tick = tick() + 5
    local Module = nil
    repeat 
        pcall(function()
            Module = require(path) 
        end)  
        task.wait(.25)
    until Module or tick() >= Tick
    print(path.Name,Module and "Found" or "Not Found","Module [SKYHUB]")
    return Module or {}
end
-- All Modules
local StagesData = LoadModule(game:GetService("ReplicatedStorage").Modules.Data.StagesData)


-- All Functions
local function DisplayToIndexStory(arg)
    for i,v in pairs(StagesData["Story"]) do
        if v["StageData"]["Name"] == arg then
            return i
        end
    end 
    return ""
end
local function DisplayToIndexLegend(arg)
    for i,v in pairs(StagesData["LegendStage"]) do
        if v["StageData"]["Name"] == arg then
            return i
        end
    end 
    return ""
end
local function DisplayToIndexDungeon(arg)
    for i,v in pairs(StagesData["Dungeon"]) do
        if v["StageData"]["Name"] == arg then
            return i
        end
    end 
    return ""
end
local function DisplayToIndexRaid(arg)
    for i,v in pairs(StagesData["Raid"]) do
        if v["StageData"]["Name"] == arg then
            return i
        end
    end 
    return ""
end
local function Len(tab)
    local count = 0
    for i,v in pairs(tab) do
        count = count + 1
    end
    return count
end
local function IndexToDisplay(arg)
    return StagesData["Story"][arg]["StageData"]["Name"]
end

-- All Variables
-- local Key = "Onio_#@@421"
local plr = game.Players.LocalPlayer
local Character = plr.Character or plr.CharacterAdded:Wait()
local RBXGeneral = TextChatService.TextChannels.RBXGeneral
local Inventory = {}
game:GetService("ReplicatedStorage").Networking.RequestInventory.OnClientEvent:Connect(function(value)
    Inventory = value
end)
local Settings ={

    ["Select Mode"] = "Portal", -- Portal , Dungeon , Story , Legend Stage , Raid
    ["Auto Join Rift"] = false,
    ["Auto Join Boss Event"] = false,

    ["Party Mode"] = false,

    ["Story Settings"] = {
        ["Difficulty"] = "Normal",
        ["Act"] = "Act1",
        ["StageType"] = "Story",
        ["Stage"] = "Planet Namak",
        ["FriendsOnly"] = false
    },
    ["Raid Settings"] = {
        ["Difficulty"] = "Nightmare",
        ["Act"] = "Act1",
        ["StageType"] = "Raid",
        ["Stage"] = "Spider Forest",
        ["FriendsOnly"] = false
    },
    ["Legend Settings"] = {
        ["Difficulty"] = "Normal",
        ["Act"] = "Act1",
        ["StageType"] = "LegendStage",
        ["Stage"] = "Sand Village",
        ["FriendsOnly"] = false
    },
    ["Dungeon Settings"] = {
        ["Difficulty"] = "Nightmare",
        ["Act"] = "Act1",
        ["StageType"] = "Dungeon",
        ["Stage"] = "Mountain Shrine (Natural)",
        ["FriendsOnly"] = false
    },
    ["Portal Settings"] = {
        ["ID"] = 113, -- 113 Love , 87 Winter
        ["Tier Cap"] = 10,
        ["Method"] = "Highest", -- Highest , Lowest
        ["Ignore Stage"] = {},
        ["Ignore Modify"] = {},
    },
}

if _G.User[plr.Name] then
    for i,v in pairs(_G.User[plr.Name]) do
        Settings[i] = v
    end
end
warn(Settings["Party Member"],plr.Name,_G.User[plr.Name])
game:GetService("ReplicatedStorage").Networking.RequestInventory:FireServer("RequestData")
task.spawn(function()
    task.wait(2)
    if game.PlaceId == 16146832113 then     
        if Settings["Party Mode"]  then
            print("Im here 2")
            if not Settings["Party Member"]  then
                print("Im here 3")
                -- TextChatService.OnIncomingMessage = function(message)
                --     if message.Text:match(Key) then
                --         local Split = message.Text:split("|")
                --         if Split[3] == plr.Name and Split[2] == "Join" then
                --             if Split[4] == "Portal" then
                --                 game:GetService("ReplicatedStorage"):WaitForChild("Networking"):WaitForChild("Portals"):WaitForChild("PortalEvent"):FireServer(
                --                     "JoinPortal",
                --                     Split[5]
                --                 )
                --             end
                --         end
                --     end
                -- end
                while task.wait(5) do
                    local requestTo = game:GetService("HttpService"):JSONDecode(game:HttpGet("https://api.championshop.date/party-aa/" .. game.Players.LocalPlayer.Name))
                    local ost = requestTo["status"] == "success" and requestTo["value"]["os"] or 0
                    if tostring(requestTo["status"]) == "success" and requestTo["value"] and tonumber(requestTo["value"]["os"]) >= os.time() then
                        warn("Join")
                        if requestTo["value"]["type"] == "Portal" then
                            game:GetService("ReplicatedStorage"):WaitForChild("Networking"):WaitForChild("Portals"):WaitForChild("PortalEvent"):FireServer(
                                "JoinPortal",
                                requestTo["value"]["data"]
                            )
                        elseif requestTo["value"]["type"] == "Normal" then
                            game:GetService("ReplicatedStorage"):WaitForChild("Networking"):WaitForChild("LobbyEvent"):FireServer( 
                                "JoinMatch",
                                requestTo["value"]["data"]
                            )
                        elseif requestTo["value"]["type"] == "Rift" then
                            game:GetService("ReplicatedStorage"):WaitForChild("Networking"):WaitForChild("Rifts"):WaitForChild("RiftsEvent"):FireServer( 
                                "Join",
                                requestTo["value"]["data"]
                            )
                        end
                       
                    end
                end
            else
                local UUID = nil
                local Type = false
                game:GetService("ReplicatedStorage").Networking.Portals.PortalReplicationEvent.OnClientEvent:Connect(function(index,value)
                    if index == "Replicate" and tostring(value["Owner"]) == plr.Name then
                        Type = true
                        UUID = value["GUID"]
                    end
                end)
                game:GetService("ReplicatedStorage").Networking.MatchReplicationEvent.OnClientEvent:Connect(function(index,value)
                    warn(index,value,tostring(value["Owner"]) == plr.Name)
                    if index == "AddMatch" and tostring(value["Host"]) == plr.Name then
                        Type = false
                        UUID = value["GUID"]
                        print(value)
                    end
                end)
                task.spawn(function()
                    while task.wait() do
                        if UUID then
                            print(UUID)
                            for i,v in pairs(Settings["Party Member"]) do
                                local response = request({
                                    ["Url"] = "https://api.championshop.date/party-aa",
                                    ["Method"] = "POST",
                                    ["Headers"] = {
                                        ["content-type"] = "application/json"
                                    },
                                    ["Body"] = game:GetService("HttpService"):JSONEncode({
                                        ["index"] = v,
                                        ["value"] = {
                                            ["type"] = Type and "Portal" or "Normal",
                                            ["data"] = UUID,
                                            ["os"] = os.time() + 120
                                        },
                                    })
                                })
                                -- RBXGeneral:SendAsync(table.concat({Key,"Join",plr.Name,"Portal",UUID},"|")) 
                            end
                            task.wait(10)
                        end
                    end
                end)
            end
            
        end
        local function GetItem(ID)
            game:GetService("ReplicatedStorage").Networking.RequestInventory:FireServer("RequestData")
            local Items = {}
            for i,v in pairs(Inventory) do
                if v["ID"] == ID then
                    Items[i] = v
                end
            end
            return Items
        end
        function AllPlayerInGame()
            print(Settings["Party Member"])
            for i,v in pairs(Settings["Party Member"]) do
                if not game:GetService("Players"):FindFirstChild(v) then
                    return false
                end
            end
            return true
        end
        local WaitTime = 120
        if Settings["Auto Join Rift"] and workspace:GetAttribute("IsRiftOpen") then
            while true do
                if AllPlayerInGame() then
                    Next_(WaitTime)
                    if AllPlayerInGame() then 
                        task.wait(math.random(2,10))
                        local Rift = require(game:GetService("StarterPlayer").Modules.Gameplay.Rifts.RiftsDataHandler)
                        local GUID = nil
                        for i,v in pairs(Rift.GetRifts()) do
                            if Len(v["Players"]) and not v["Teleporting"] then
                                GUID = v["GUID"]
                            end
                        end
                        game:GetService("ReplicatedStorage"):WaitForChild("Networking"):WaitForChild("Rifts"):WaitForChild("RiftsEvent"):FireServer( 
                            "Join",
                            GUID
                        )
                        for i,v in pairs(Settings["Party Member"]) do
                            local response = request({
                                ["Url"] = "https://api.championshop.date/party-aa",
                                ["Method"] = "POST",
                                ["Headers"] = {
                                    ["content-type"] = "application/json"
                                },
                                ["Body"] = game:GetService("HttpService"):JSONEncode({
                                    ["index"] = v,
                                    ["value"] = {
                                        ["type"] = "Rift",
                                        ["data"] = GUID,
                                        ["os"] = os.time() + 120
                                    },
                                })
                            })
                        end
                    end
                end
                task.wait(2)
            end
        end
        if Settings["Auto Join Boss Event"] then
            
        end
        if Settings["Select Mode"] == "Portal" then
            local Settings_ = Settings["Portal Settings"]
            local function Ignore(tab1,tab2)
                for i,v in pairs(tab1) do
                    if table.find(tab2,v) then
                        return false
                    end 
                end
                return true
            end
            local function PortalSettings(tabl)
                local AllPortal = {}
                for i,v in pairs(tabl) do
                    
                    if not table.find(Settings_["Ignore Stage"],IndexToDisplay(v["ExtraData"]["Stage"]["Stage"])) and Ignore(v["ExtraData"]["Modifiers"],Settings_["Ignore Modify"]) and Settings_["Tier Cap"] >= v["ExtraData"]["Tier"] then
                        AllPortal[#AllPortal + 1] = {
                            [1] = i,
                            [2] = v["ExtraData"]["Tier"]
                        }
                        
                    end
                end
                table.sort(AllPortal, function(a, b)
                    return a[2] > b[2]
                end)
                return AllPortal[1][1] or false
            end
            while true do
                if AllPlayerInGame() then
                    Next_(WaitTime)
                    if AllPlayerInGame() then 
                        local Portal = PortalSettings(GetItem(Settings_["ID"]))
                        if Portal then
                            local args = {
                                [1] = "ActivatePortal",
                                [2] = Portal
                            }
                            
                            game:GetService("ReplicatedStorage"):WaitForChild("Networking"):WaitForChild("Portals"):WaitForChild("PortalEvent"):FireServer(unpack(args))
                        end
                    end
                end
                task.wait(2)
            end
        elseif Settings["Select Mode"] == "Story" then
            while true do
                if AllPlayerInGame() then
                    Next_(WaitTime)
                    if AllPlayerInGame() then 
                        local StorySettings = Settings["Story Settings"]
                        StorySettings["Stage"] = DisplayToIndexStory(StorySettings["Stage"])
                        local args = {
                            [1] = "AddMatch",
                            [2] = StorySettings
                        }
                        
                        game:GetService("ReplicatedStorage"):WaitForChild("Networking"):WaitForChild("LobbyEvent"):FireServer(unpack(args))
                        task.wait(10)
                        local args = {
                            [1] = "StartMatch"
                        }
                        
                        game:GetService("ReplicatedStorage"):WaitForChild("Networking"):WaitForChild("LobbyEvent"):FireServer(unpack(args))
                    end
                end
                task.wait(2)
            end
        elseif Settings["Select Mode"] == "Dungeon" then
            while true do
                if AllPlayerInGame() then
                    Next_(WaitTime)
                    if AllPlayerInGame() then 
                        local DungeonSettings = Settings["Dungeon Settings"]
                        DungeonSettings["Stage"] = DisplayToIndexDungeon(DungeonSettings["Stage"])
                        local args = {
                            [1] = "AddMatch",
                            [2] = DungeonSettings
                        }
                        
                        game:GetService("ReplicatedStorage"):WaitForChild("Networking"):WaitForChild("LobbyEvent"):FireServer(unpack(args))
                        task.wait(10)
                        local args = {
                            [1] = "StartMatch"
                        }
                        
                        game:GetService("ReplicatedStorage"):WaitForChild("Networking"):WaitForChild("LobbyEvent"):FireServer(unpack(args))
                    end
                end
                task.wait(2)
            end
        elseif Settings["Select Mode"] == "Legend Stage" then
            while true do
                if AllPlayerInGame() then
                    Next_(WaitTime)
                    if AllPlayerInGame() then 
                        local LegendSettings = Settings["Legend Settings"]
                        LegendSettings["Stage"] = DisplayToIndexLegend(LegendSettings["Stage"])
                        local args = {
                            [1] = "AddMatch",
                            [2] = LegendSettings
                        }
                        
                        game:GetService("ReplicatedStorage"):WaitForChild("Networking"):WaitForChild("LobbyEvent"):FireServer(unpack(args))
                        task.wait(10)
                        local args = {
                            [1] = "StartMatch"
                        }
                        
                        game:GetService("ReplicatedStorage"):WaitForChild("Networking"):WaitForChild("LobbyEvent"):FireServer(unpack(args))
                    end
                end
                task.wait(2)
            end
        elseif Settings["Select Mode"] == "Raid" then
            while true do
                if AllPlayerInGame() then
                    Next_(WaitTime)
                    if AllPlayerInGame() then 
                        local RaidSettings = Settings["Raid Settings"]
                        RaidSettings["Stage"] = DisplayToIndexRaid(RaidSettings["Stage"])
                        local args = {
                            [1] = "AddMatch",
                            [2] = RaidSettings
                        }
                        
                        game:GetService("ReplicatedStorage"):WaitForChild("Networking"):WaitForChild("LobbyEvent"):FireServer(unpack(args))
                        task.wait(10)
                        local args = {
                            [1] = "StartMatch"
                        }
                        
                        game:GetService("ReplicatedStorage"):WaitForChild("Networking"):WaitForChild("LobbyEvent"):FireServer(unpack(args))
                    end
                end
                task.wait(2)
            end
        end
    else

    end    
end)
